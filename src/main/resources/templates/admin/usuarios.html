<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Usuarios - Administrador</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        .stat-card {
            transition: transform 0.2s;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        .badge-estado {
            font-size: 0.8em;
            padding: 0.4em 0.8em;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- HEADER -->
        <div class="dashboard-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-users me-2"></i>Gestión de Usuarios</h1>
                    <p class="lead mb-0">Administración completa del sistema - Todos los usuarios</p>
                </div>
                <div class="col-md-4 text-end">
                    <a th:href="@{/admin/dashboard}" class="btn btn-light">
                        <i class="fas fa-arrow-left me-1"></i>Volver al Dashboard
                    </a>
                    <a th:href="@{/admin/citas}" class="btn btn-light">
                        <i class="fas fa-calendar-alt me-1"></i>Citas
                    </a>
                </div>
            </div>
        </div>

        <!-- ESTADÍSTICAS DE USUARIOS -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <h2 th:text="${totalUsuarios}" class="text-primary">0</h2>
                        <p class="card-text">Total Usuarios</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <h2 th:text="${usuariosActivos}" class="text-success">0</h2>
                        <p class="card-text">Usuarios Activos</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <h2 th:text="${usuariosInactivos}" class="text-danger">0</h2>
                        <p class="card-text">Usuarios Inactivos</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <a th:href="@{/admin/usuarios/nuevo}" class="btn btn-primary btn-lg">
                            <i class="fas fa-plus me-1"></i>Nuevo Usuario
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- BARRA DE BÚSQUEDA Y FILTROS -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Buscar usuario..." id="buscarUsuario">
                            <button class="btn btn-outline-primary" type="button" id="btnBuscar">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary" id="btnFiltrarActivos">
                                <i class="fas fa-check-circle"></i> Activos
                            </button>
                            <button class="btn btn-outline-secondary" id="btnFiltrarInactivos">
                                <i class="fas fa-times-circle"></i> Inactivos
                            </button>
                            <button class="btn btn-outline-secondary" id="btnMostrarTodos">
                                <i class="fas fa-users"></i> Todos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LISTA DE USUARIOS -->
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>Lista de Usuarios del Sistema
                </h5>
                <span class="badge bg-light text-dark" th:text="'Total: ' + ${totalUsuarios}">Total: 0</span>
            </div>
            <div class="card-body">
                <!-- Mensaje de éxito -->
                <div th:if="${param.exito}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>Usuario guardado exitosamente
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Mensaje si no hay usuarios -->
                <div th:if="${usuarios == null or usuarios.empty}" class="text-center py-5">
                    <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No hay usuarios registrados</h4>
                    <p class="text-muted">No se encontraron usuarios en el sistema.</p>
                    <a th:href="@{/admin/usuarios/nuevo}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Crear Primer Usuario
                    </a>
                </div>

                <!-- Tabla de usuarios -->
                <div th:if="${usuarios != null and not usuarios.empty}">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped" id="tablaUsuarios">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Roles</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="usuario : ${usuarios}">
                                    <td th:text="${usuario.id}">#</td>
                                    <td>
                                        <strong th:text="${usuario.username}">username</strong>
                                    </td>
                                    <td th:text="${usuario.email}">email@ejemplo.com</td>
                                    <td>
                                        <span th:if="${usuario.roles != null and not usuario.roles.empty}">
                                            <span th:each="rol, stat : ${usuario.roles}">
                                                <span class="badge bg-info badge-estado" th:text="${rol.nombre}">Rol</span>
                                                <span th:if="${not stat.last}">, </span>
                                            </span>
                                        </span>
                                        <span th:if="${usuario.roles == null or usuario.roles.empty}" class="text-muted">
                                            Sin roles
                                        </span>
                                    </td>
                                    <td>
                                        <span th:if="${usuario.estado == 1}" class="badge bg-success badge-estado">
                                            <i class="fas fa-check me-1"></i>Activo
                                        </span>
                                        <span th:if="${usuario.estado == 0}" class="badge bg-danger badge-estado">
                                            <i class="fas fa-times me-1"></i>Inactivo
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a th:href="@{/admin/usuarios/editar/} + ${usuario.id}" 
                                               class="btn btn-outline-primary" 
                                               th:title="'Editar usuario ' + ${usuario.username}">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a th:href="@{/admin/usuarios/estado/} + ${usuario.id}" 
                                               class="btn" 
                                               th:classappend="${usuario.estado == 1} ? 'btn-outline-warning' : 'btn-outline-success'"
                                               th:title="${usuario.estado == 1} ? 'Desactivar usuario' : 'Activar usuario'">
                                                <i th:classappend="${usuario.estado == 1} ? 'fas fa-toggle-off' : 'fas fa-toggle-on'"></i>
                                            </a>
                                            <button class="btn btn-outline-info" 
                                                    th:onclick="'verDetalles(' + ${usuario.id} + ')'"
                                                    th:title="'Ver detalles de ' + ${usuario.username}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- INFORMACIÓN DEL SISTEMA -->
        <div class="card mt-4">
            <div class="card-body">
                <h6><i class="fas fa-info-circle text-info me-2"></i>Información del Sistema</h6>
                <p class="mb-0 small text-muted">
                    <strong>Vista:</strong> Administrador | 
                    <strong>Usuarios cargados:</strong> <span th:text="${totalUsuarios}"></span> |
                    <strong>Activos/Inactivos:</strong> <span th:text="${usuariosActivos}"></span>/<span th:text="${usuariosInactivos}"></span> |
                    <strong>Última actualización:</strong> <span th:text="${#dates.format(new java.util.Date(), 'dd/MM/yyyy HH:mm')}"></span>
                </p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Funcionalidad de búsqueda y filtros
        document.addEventListener('DOMContentLoaded', function() {
            const buscarUsuario = document.getElementById('buscarUsuario');
            const btnBuscar = document.getElementById('btnBuscar');
            const btnFiltrarActivos = document.getElementById('btnFiltrarActivos');
            const btnFiltrarInactivos = document.getElementById('btnFiltrarInactivos');
            const btnMostrarTodos = document.getElementById('btnMostrarTodos');
            const tablaUsuarios = document.getElementById('tablaUsuarios');

            // Función para aplicar filtros
            function aplicarFiltros(filtro = 'TODOS', busqueda = '') {
                const filas = tablaUsuarios.querySelectorAll('tbody tr');
                let usuariosVisibles = 0;

                filas.forEach(fila => {
                    const username = fila.querySelector('td:nth-child(2) strong').textContent.toLowerCase();
                    const email = fila.querySelector('td:nth-child(3)').textContent.toLowerCase();
                    const estado = fila.querySelector('td:nth-child(5) .badge').textContent.toLowerCase();
                    
                    let mostrar = true;

                    // Filtro por estado
                    if (filtro === 'ACTIVOS' && !estado.includes('activo')) {
                        mostrar = false;
                    } else if (filtro === 'INACTIVOS' && !estado.includes('inactivo')) {
                        mostrar = false;
                    }

                    // Búsqueda por texto
                    if (busqueda && !username.includes(busqueda) && !email.includes(busqueda)) {
                        mostrar = false;
                    }

                    fila.style.display = mostrar ? '' : 'none';
                    if (mostrar) usuariosVisibles++;
                });

                // Actualizar contador
                const badge = document.querySelector('.card-header .badge');
                if (badge) {
                    badge.textContent = `Mostrando: ${usuariosVisibles} de ${filas.length}`;
                }
            }

            // Event listeners
            btnBuscar.addEventListener('click', () => {
                aplicarFiltros('TODOS', buscarUsuario.value.toLowerCase());
            });

            buscarUsuario.addEventListener('input', () => {
                aplicarFiltros('TODOS', buscarUsuario.value.toLowerCase());
            });

            btnFiltrarActivos.addEventListener('click', () => {
                aplicarFiltros('ACTIVOS', buscarUsuario.value.toLowerCase());
            });

            btnFiltrarInactivos.addEventListener('click', () => {
                aplicarFiltros('INACTIVOS', buscarUsuario.value.toLowerCase());
            });

            btnMostrarTodos.addEventListener('click', () => {
                buscarUsuario.value = '';
                aplicarFiltros('TODOS', '');
            });

            // Aplicar filtros iniciales
            aplicarFiltros();
        });

        // Función para ver detalles (simulada)
        function verDetalles(usuarioId) {
            alert(`Detalles del Usuario ID: ${usuarioId}\n\nEsta funcionalidad está en desarrollo.`);
        }

        // Auto-cerrar alertas después de 5 segundos
        setTimeout(() => {
            const alertas = document.querySelectorAll('.alert');
            alertas.forEach(alerta => {
                const bsAlert = new bootstrap.Alert(alerta);
                bsAlert.close();
            });
        }, 5000);
    </script>
</body>
</html>